---
publishDate: 2023-08-11T00:00:00Z
title: nMap Explorations - A Great Time - DEF CON 31 (Blue Team Village)
category: video
image: '~/assets/images/nmap-exploration.jpg'
excerpt: My Talk from DEF CON 31 in 2023
tags:
  - video
  - information-security
  - talk
  - defcon
  - blue-team
  - threat-hunting
  - teaching
---

import Logo from '~/components/Logo.astro';
import { YouTube, Tweet, Vimeo } from 'astro-embed';

<YouTube id="kKeV-Es17dc" />

## (Threat Hunting) "(n)Map Exploration: A Great Time in Remote Destinations"

Let's take a look at activity within a corporate environment. Can we find actions that stand out or might be suspicious?

# Overview

## What will we learn?
There are a number of concepts we will go over and learn in this walkthrough:

* What is reconnaissance in a security/threat hunt context?
* What are some ways that adversaries can identify points of exploitation within an environment?
* What are some commonly abused services that adversaries use?
* How can we walk through the thought process associated with a Threat Hunt from hypothesis to tangible results?
* What tools do we have at our disposal and what can we do with them?
* Can we go deeper and find out more after validating our hypothesis?

# Initial Required Concepts
In order to dive into the hunt, we need to have some baseline information to better understand what we are seeking to find. Let us take a look at some of these now.

## What is reconnaissance?
In a security context, reconnaissance is the process of gathering information about a particular target. It's important to recognize that reconnaissance is *not* always malicious in nature. It is not unexpected or unheard of to see some tools in use within the organization that perform this activity. Reconnaissance is often utilized prior to potential exploitation as an adversary would build out a "map" of items that exists in a particular environment.

## What are some ways that adversaries can identify points of exploitation?
An adversary can begin with some basic web searches to find information that is freely available on the internet to begin building a model associated with a particular "entity" - often in this context the "entity" is an organization. We call this freely-available information on the internet Open Source Intelligence, or OSINT for short. There is often a limit to the usefulness of the information provided by OSINT resources as it pertains to actively using it against an entity. 

## What if the adversary is already connected to the network?
If the adversary already has a limited foothold into the network, there are more effective things that the adversary can do:
* Build a network map of the environment - what systems are there? what operating systems are there?
* Identify services that the adversary could then utilize to move deeper into systems/the network.
* Exfiltrate data

From a security point of view, we call this building a list of systems "Enumeration"

## What tools could be used to do this enumeration within the network?
Some tools for this include:
* Network Scanning Tools: Used for building out systems associated with a particular network, including open ports, operating system type, and more. A few examples of applications in this group include the popular tool nmap and as well masscan.
* Vulnerability Scanners: OpenVAS/Nessus are two vulnerability scanners that could theoretically be used to identify hosts within a network.
* Built-in OS Tools: The ping tool could be used to identify available hosts within a network, though

**Now that we understand more about reconnaissance, let's put these concepts together to see if we can build a Threat Hunt with these ideas in mind!**

# Threat Hunting

## What is Threat Hunting?
Threat Hunting (TH) is a process of being proactive of unveiling unknown-knowns and unknown-unknowns to better our security posture

# Hypothesis
In order to begin the Threat Hunt, we need to have a reason to start the hunt. To start, we will need to come up with a hypothesis.

### What is a hypothesis?
   A hypothesis can be described as something we think might be occurring or something that we think might be taking place in an environment. A hypothesis focuses on the 6 W's:
   
   * Who: Who is doing the activity?
   * What: What is happening?
   * Where: Where (What systems/networks) is this happening?
   * When: What time/time period did this happen?
   * Why: What is the end goal for the activity being performed?
   * How: How is the activity occurring in the system?
   
   ### How do we create a hypothesis?
   For HOW to create a hypothesis for Threat Hunting, you can read an in-depth guide here: (insert link). 
   
   For now we will go over the hypothesis I have created for this scenario.
   
   Let's create a hypothesis to hunt for reconnaissance!

   ### Broad Hypothesis
   The company has reconnaissance activity within the network.
  
   ### Narrow hypothesis
   Reconnaissance activity is occurring in the Magnum Tempus environment, and some of the activity is malicious.

# Transitioning from a Hypothesis to a Query

## How can we formulate a query based on our hypothesis?
Our initial hypothesis presumes that there is reconnaissance activity within the environment. While this is most certainly true, we need to dig deeper. There may indeed be this ocurring, but as we noted above, not all reconnaissance activity is outright malicious.

First we need to understand what tools we have available. For this Hunt, we are using Splunk, however many of the procedures/methods we use can and should be used with other query languages/log platforms.

Since we know our log data is in Splunk, we first need to determine what log sources we have available to us. 

We could modify our index to include ALL log source data using a wildcard query like this:

```
index="*"
```

HOWEVER, this is considered **bad practice** as doing so is an expensive (resource-intensive) query and could cause undesirable effects on the Splunk (or other Log Aggregator) server and could hinder other searches being done on the system.

Thanks to our friend, [Cereal Killer](https://github.com/blueteamvillage/obsidian-threat-hunting/blob/first-draft/KC3/Sniffing_Compromise_Cereal.md), we can utilize the following query to find the indexes (source) of data to query against:

```
| eventcount summarize=false index=* | dedup index | fields index
```

While you may not know this, when I think of nmap usage, I think of it being used on Linux distributions. As we can see above, there is an index for Linux, so let's start there!

In Splunk queries, we start by calling the index (source) of the data we are querying against:

```
index="linux"
```
We can query with just this, however we will get ALL data in the associated log:

> NOTE: 
> We need to change the time filter to the time period we are checking against for this specific scenario because we don't know exactly when the log data starts/stops.
> In your own Threat Hunting (outside of this scenario), you will want to identify a timeframe to conduct your searches. This could be 24 Hours, 1 Week, 1 Month.

In this scenario for this hunt, we are focusing on the whole day of 2023-04-29.
![image]()

In Linux, an example of a basic host nmap scan command line entry would look like this:

>nmap -sn 192.168.1.0/24

To make it easier, we can expand on our existing query and add just the text "nmap" to it, since the nmap application is just simply *nmap*.

```
index="linux" (nmap)
```

Okay, so for some reason this did not provide any results.

Did we do something wrong here? *Not exactly.* We're conducting a threat hunt for something we THINK might be in the environment. A threat hunt will not always be successful, but sometimes it can be. 

Let's look at the index list again. So we see there are a few items that might be interesting to try. We see sysmonforlinux. Sysmon is a tool that is used to get telemetry data (information about what's happening on the computer, even activities that the end user doesn't ever see) and forwards this data to a log collector. This might also be a great source to query against.

We can also try adding some of the other tools we referenced above to the query as well.

## How can we refine this query?

Let's start with the previous query:

```
index="linux" (nmap)
```

So there was no nmap activity in the linux logs in Splunk. Let's pivot to include another potential log source as well as another command line reconnaissance tool, masscan.

Masscan might not be as commonly used as nmap and if we think like a potential adversary, we might want to use a tool that is less commonly used and therefore potentially less likely to be recognized.

An example of a masscan command line would be:

>masscan -p 80,443 192.168.1.0/24

This scan is specifically looking for open HTTP (80) and HTTPS (443 Secure!) ports between 192.168.1.0 and 192.168.1.254.

We can modify our search as seen here:

```
index IN (linux,sysmonforlinux) (masscan OR nmap)
```

This query did not net us any relevant hits, either.

Let's pivot again - this is normal. Everything is fine.

## How can we refine this query since the previous did not get us what we expected?

Let's start with the initial query:

```
index="linux" (nmap)
```

Our initial hypothesis presumes that we have reconnaissance activity in the environment. We started looking at Linux systems to see if there was activity there, but perhaps we made a problematic first assumption that the reconnaissance would come from a Linux system. Let's go with the "sysmon" and "windows" index choices. Much like Sysmon for Linux, Windows Sysmon can provide telemetry from Microsoft Windows systems and there actually is a nmap version that can be used in Windows. We will not include masscan at this point because it's less common in Windows.

Let's go!

Here's what we should modify our search query to:

```
index IN (sysmon,windows) (nmap)
```

Let's run this query!

We have hits!

Let's look at the overall results:

182 events - digging through this, we could probably refine this list down. Let's take a look at the hosts that show nmap activity. If we click on the host field on the left side, we see that 5 systems have been identified with something related to "nmap" on it:

<INSERT IMAGE FOR HOSTS HERE>

What we also notice is that a LOT of activity related to nmap appears to be by one particular system:

>wkst16.magnumtempus.financial

Let's dig into this system a bit to see what's happening.

We need to modify the query again

```
index IN (windows,sysmon) (nmap) AND host="wkst16.magnumtempus.financial"
```

Running this, we see 152 events that match this query.

Looking through these entries the only directly interesting entry is one associated with Powershell, but it appears to be activity associated with installing nmap, so I don't see this as particularly nefarious.

We also see this system is associated with Seth Morgan, an IT Engineer. Without knowing much more about what an IT Engineer is within the orgainzation, let's take a moment to presume this is expected activity by this user.

Let's compare with *Excluding* the host from the results:

```
index IN (windows,sysmon) (nmap) AND NOT host="wkst16.magnumtempus.financial"
```

29 events!

Let's take another look at the breakdown of the hosts associated with this query:


We see now that the top talker for this activity is:

> iot-eng-wkst.magnumtempus.financial

Let's refine our query and dig more into this system:

```
index IN (windows,sysmon) (nmap) AND NOT host="wkst16.magnumtempus.financial" AND host="iot-eng-wkst.magnumtempus.financial"
```

[[Top]](#top)