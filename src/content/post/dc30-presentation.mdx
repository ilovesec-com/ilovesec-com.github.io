---
publishDate: 2022-08-13T00:00:00Z
title: Go Phish! Visualizing Basic Malice - DEF CON 30 (Blue Team Village)
category: video
image: '~/assets/images/go-phish.jpg'
excerpt: My Talk from DEF CON 30 in 2022
tags:
  - video
  - information-security
  - talk
  - defcon
  - blue-team
  - threat-hunting
  - teaching

---

import Logo from '~/components/Logo.astro';
import { YouTube, Tweet, Vimeo } from 'astro-embed';

<YouTube id="oXlCyvFed6Q" />

# (Threat Hunting) Kill Chain 1: "Go Phish: Visualizing Basic Malice"

Come take a dive into the data lake and cast some queries to find proof that users have run files from malicious actors. How can we prove the existence of troublesome activity in the environment? We will take a journey as if we are a new member of the Magnum Tempus Financial Security Team and proceed through a Threat Hunt through the eyes of a newbie in the field of Threat Hunting.

# Overview

## What will we learn?
There are a number of concepts we will go over and learn in this walkthrough:

* What is phishing and what is a phishing payload?
* What is Visual Basic for Applications?
* What are Macros and what does this have to do with phishing and Threat Hunting?
* How can we walk through the thought process associated with a Threat Hunt from hypothesis to tangible results?
* What tools do we have at our disposal and what can we do with them?
* Can we go deeper and find out more after validating our hypothesis?

# Initial Required Concepts
In order to dive into the hunt, we need to have some baseline information to better understand what we are seeking to find. Let us take a look at some of these now.

## What is phishing?
In simple terms, phishing in this context is an attempt by an adversary to use methods to obtain credentials in an illicit manner using email communications.

## What is a phishing payload?
A phishing payload is the means in which an adversary attempts to obtain the credentials of a target. The payload could be a link that sends an unsuspecting victim to a webpage that emulates a known website (like Microsoft Office 365 portal or Banking logon page) to collect usernames and passwords. Here are a few examples of malicious emails I have seen in my information security experiences:



Another type of payload can be a document or file specially crafted to behave in a certain manner or take specific actions to attempt to collect credentials from a user's system:


Let's look at what we see in the above screenshot:
> 1. The company email is mycoinsnow.com but the email sender is mycolnsnow.com - this is a typosquat of the domain.
> 2. Misspelling 'document' in the text. Additionally, creating a sense of urgency on the recipient that action is required by a specified date.
> 3. Document attached is a .docx file that simply says "invoice" with no other indication on what it is for.

Attacks using the above type of email often utilize the Visual Basic for Applications (VBA) coding present in Microsoft Office Suite, primarily in Microsoft Word, Excel, and PowerPoint.

## What is Visual Basic for Applications?
Visual Basic for Applications (VBA) is a slightly stripped down/limited version of Visual Basic coding language that can be used in Microsoft applications to add functionality and extensibility not natively available in the applications themselves. This can be useful in helping automate repetitive actions or automate retrieval of data when certain options are chosen in a document. VBA allows system-level access to perform actions and can act outside of the Microsoft Office Applications as well. We commonly call these "Macros".

## What are the issues with Macros?
Due to how the functionality works in allowing access outside of the walled garden of Microsoft Office Suite, macros can allow an adversary the ability to make system changes or download additional malicious code via these macros with little interaction from the victim.

An example of how the VBA Macro document could appear in a Microsoft Word document can be see here:



**Now that we understand what phishing, phishing payloads, VBA, and macros are, let's put these concepts together to see if we can build a Threat Hunt with these ideas in mind!**

# Threat Hunting

## What is Threat Hunting?
Threat Hunting (TH) is a process of being proactive of unveiling unknown-knowns and unknown-unknowns to better our security posture

# Hypothesis
In order to begin the Threat Hunt, we need to have a reason to start the hunt. To start, we will need to come up with a hypothesis.

### What is a hypothesis?
   A hypothesis can be described as something we think might be occurring or something that we think might be taking place in an environment. A hypothesis focuses on the 6 W's:
   
   * Who: Who is doing the activity?
   * What: What is happening?
   * Where: Where (What systems/networks) is this happening?
   * When: What time/time period did this happen?
   * Why: What is the end goal for the activity being performed?
   * How: How is the activity occurring in the system?
   
   ### How do we create a hypothesis?
   For HOW to create a hypothesis for Threat Hunting, you can read an in-depth guide here: (insert link). 
   
   For now we will go over the hypothesis I have created for this scenario.
   
   Let's create a hypothesis to hunt for potential phishing activity!

   ### Broad Hypothesis
   Magnum Tempus employees receive malicious phishing emails.
  
   ### Narrow hypothesis
   MT Employees are targeted with Malicious Microsoft Documents containing VBA macros via phishing email. Some employees will click and open malicious documents.

# Transitioning from a Hypothesis to a Query

## How can we formulate a query based on our hypothesis?
Our initial hypothesis presumes Magnum Tempus employees receive emails with malicious documents and opens those documents.

First we need to understand what tools we have available. For this Hunt, we are using Splunk, however many of the procedures/methods we use can and should be used with other query languages/log platforms.

Since we know our log data is in Splunk, we first need to determine what log sources we have available to us. 

We could modify our index to include ALL log source data using a wildcard query like this:

```
index="*"
```

HOWEVER, this is considered **bad practice** as doing so is an expensive (resource-intensive) query and could cause undesirable effects on the Splunk (or other Log Aggregator) server and could hinder other searches being done on the system.

Thanks to our friend, [Cereal Killer](https://github.com/blueteamvillage/obsidian-threat-hunting/blob/first-draft/KC3/Sniffing_Compromise_Cereal.md), we can utilize the following query to find the indexes (source) of data to query against:

```
| eventcount summarize=false index=* | dedup index | fields index
```



We will start with Zeek logs in Splunk because we can find documents transmitted over network traffic if they are downloaded from a company email on a company asset. Zeek is used to collect telemetry data and traffic flowing through an organization's network.

In Splunk queries, we start by calling the index (source) of the data we are querying against:

```
index="zeek"
```
We can query with just this, however we will get ALL data in the associated log:



> NOTE: 
> We need to change the time filter to the time period we are checking against for this specific scenario because we don't know exactly when the log data starts/stops.
> In your own Threat Hunting (outside of this scenario), you will want to identify a timeframe to conduct your searches. This could be 24 Hours, 1 Week, 1 Month.

In this scenario for Magnum Tempus, we are focusing on 2022-02-11 through 2022-02-13


Let’s focus on document file types that are often sent as potential phishing attachments.

Some of the more common formats include Microsoft Word formats (**.doc, .docx**) and Microsoft Excel Spreadsheets (**.xls, .xlsx**). Splunk allows us to query for multiple file types at once. Note we are not necessarily looking for an **official filetype designation** because we may not know exactly if this is indexed in Splunk. Let's check for the filetypes specifically as shown here:

```
index="zeek" (.doc OR .xls OR .docx OR .xlsx)
```

We get lots of hits (863!) because a lot of documents will be sent as part of normal business: 


Let’s try to pare down the total number to a more manageable number using some common phishing terms.

## How can we refine this query?

Let's start with the previous query:

```
index="zeek" (.doc OR .xls OR .docx OR .xlsx)
```

This gave us way too many results. We want to reduce the number of files, but need to find files that could indicate potential phishing activity. Occasionally we see common terms/names in documents related to phishing activity as seen here at [SANS Common Patterns Used in Phishing Campaign Files](https://isc.sans.edu/forums/diary/Common+Patterns+Used+in+Phishing+Campaigns+Files/23403/):


Let's pick a few and run another search, this time expanding our search to other log sources within Splunk (using index IN):

Let's try including a different log source with our zeek query. 

Looking at our index from before, let's go with sysmon, as we might be able to see files accessed on endpoints (Much like how Zeek is used for network telemetry, Sysmon is used to generate telemetry data from endpoint devices in an organization.)



We can modify our search as seen here:

```
index IN (zeek,sysmon) (.doc OR .xls OR .docx OR .xlsx) (invoice OR remit OR payment OR order)
```

This query did not net us any relevant hits:



We should probably try a different approach.

## How can we refine this query since the previous did not get us what we expected?

Let's start with the initial query:

```
index="zeek" (.doc OR .xls OR .docx OR .xlsx)
```

Our initial hypothesis presumes that users executed malicious VBA macro code. Is there a way for us to determine based on log data that such a document was executed?

In a word: yes.

Reviewing [SANS Office macro execution evidence](https://isc.sans.edu/diary/Office+macro+execution+evidence/27244) we see that we can check logs for “TrustRecords” to see if there were Windows Registry modifications:


> One of the few places where macro execution leaves traces is in the "TrustRecords" entry in the registry:
> HKCU:\SOFTWARE\Microsoft\Office\16.0\Word\Security\Trusted Documents\TrustRecords
> HKCU:\SOFTWARE\Microsoft\Office\16.0\Excel\Security\Trusted Documents\TrustRecords
> HKCU:\SOFTWARE\Microsoft\Office\16.0\PowerPoint\Security\Trusted Documents\TrustRecords
>
>  -From https://isc.sans.edu/diary/Office+macro+execution+evidence/27244

Let’s take a look at what we should modify our search query to:

```
index IN (zeek,sysmon) (.doc OR .xls OR .docx OR .xlsx) (TrustRecords)
```

Let's run this query!

We have hits!



Let's look at the overall results:

62 events - this should be easier to parse. Looking at one of the first hits we see there is what appears to be an internal fileshare:



```
files.magnumtempusfinancial.com
```

For purposes of this TH, let's exclude this in the query. Since our initial hypothesis indicated that users would download and execute malicious documents downloaded from a malicious sender, we might not expect to see these files in an internal file share at first. It is possible, however, that files could be malicious and saved to the fileshare. Let's take a look to see how many of our documents that use macros are on the internal fileshare:

```
index IN (zeek,sysmon) (.doc OR .xls OR .docx OR .xlsx) (TrustRecords) AND (files.magnumtempusfinancial.com)
```

Running this, we see 26 events that match this query:


Let's compare with *Excluding* the fileshare from the results:

```
index IN (zeek,sysmon) (.doc OR .xls OR .docx OR .xlsx) (TrustRecords) AND NOT (files.magnumtempusfinancial.com)
```

Here's the first event that shows up:


> Registry value set:
> RuleName: -
> EventType: SetValue
> UtcTime: 2022-02-12 21:12:25.454
> ProcessGuid: {0522759F-229C-6208-B002-000000001002}
> ProcessId: 972
> Image: C:\Program Files\Microsoft Office\Root\Office16\WINWORD.EXE
> TargetObject: HKU\S-1-5-21-2370586174-1517003462-1142029260-1129\SOFTWARE\Microsoft\Office\16.0\Word\Security\TrustedDocuments\TrustRecords\%USERPROFILE%/Downloads/MagnumTempus-Policy-Violation-matt.tristique@magnumtempusfinancial.com.doc
> Details: Binary Data
> User: MAGNUMTEMPUS\matt.tristique 

