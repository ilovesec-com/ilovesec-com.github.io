---
import { APP_BLOG } from 'astrowind:config';

import Grid from '~/components/blog/Grid.astro';

import { getBlogPermalink } from '~/utils/permalinks';
import { findLatestPosts } from '~/utils/blog';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import type { Widget } from '~/types';
import Button from '../ui/Button.astro';

export interface Props extends Widget {
  title?: string;
  linkText?: string;
  linkUrl?: string | URL;
  information?: string;
  count?: number;
}

const {
  title = await Astro.slots.render('title'),
  linkText = 'View all posts',
  linkUrl = getBlogPermalink(),
  information = await Astro.slots.render('information'),
  count = 4,

  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

const posts = APP_BLOG.isEnabled ? await findLatestPosts({ count }) : [];
---

const feedUrl = `https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Filovesec.substack.com%2Ffeed`;

async function fetchLatestPosts() {
  try {
    const response = await fetch(feedUrl);
    const data = await response.json();

    // Get up to three items from the feed
    const latestItems = (data.items || []).slice(0, 3);

    if (latestItems.length > 0) {
      const postsHTML = latestItems.map(item => {
        // Assuming the first image in the content is the featured image
        const imageUrlMatch = item.content.match(/<img src="([^"]+)"/);
        const imageUrl = imageUrlMatch ? imageUrlMatch[1] : ''; // Default to empty if no image found

        // Extract title and subtitle (assuming subtitle is in the description)
        const title = item.title;
        const subtitle = item.description || 'No Subtitle Provided';

        return `
          <div class="post col-md-4 my-4">
            <a href="${item.link}" class="link_with_image" target="_blank">
              <div class="post_image_wrapper">
                ${imageUrl ? `<img src="${imageUrl}" alt="${title}" class="featured-image">` : ''}
              </div>
              <div class="post_meta_data">
                <h3>${title}</h3>
                <p><strong>${subtitle}</strong></p>
              </div>
            </a>
          </div>
        `;
      }).join('');

      // Update HTML with the latest posts details
      document.getElementById('latest-posts').innerHTML = postsHTML;
    } else {
      document.getElementById('latest-posts').textContent = 'No posts available.';
    }
  } catch (error) {
    document.getElementById('latest-posts').textContent = 'Failed to load the latest posts.';
    console.error('Error fetching the RSS feed:', error);
  }
}

fetchLatestPosts();

{
  APP_BLOG.isEnabled ? (
    <WidgetWrapper id={id} isDark={isDark} containerClass={classes?.container as string} bg={bg}>
      <div class="flex flex-col lg:justify-between lg:flex-row mb-8">
        {title && (
          <div class="md:max-w-sm">
            <h2
              class="text-3xl font-bold tracking-tight sm:text-4xl sm:leading-none group font-heading mb-2"
              set:html={title}
            />
            {APP_BLOG.list.isEnabled && linkText && linkUrl && (
              <Button variant="link" href={linkUrl}>
                {' '}
                {linkText} Â»
              </Button>
            )}
          </div>
        )}

        {information && <p class="text-muted dark:text-slate-400 lg:text-sm lg:max-w-md" set:html={information} />}
      </div>

<div id="substack-feed-embed"></div>
<div></div>
<script>
window.SubstackFeedWidget = {
substackUrl: "ilovesec.substack.com",
posts: 3,
layout: "center",
colors: {
primary: "#FFFFFF",
secondary: "#BEBEBE",
background: "#030620",
}
};
</script>
<script src="https://substackapi.com/embeds/feed.js" async></script>

<div class="container my-4">
   <div class="row">
     <h1>My Three Latest Posts:</h1>
    <div id="latest-posts" class="row">
        Loading latest post...
    </div>
  </div>
</div>

    </WidgetWrapper>
  ) : (
    <Fragment />
  )
}
